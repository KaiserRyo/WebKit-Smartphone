#!/bin/bash

export CACHEOSDIR=$OLYMPIAROOT/os_latest/$CPUNAME
export CACHEDIR=$CACHEOSDIR/os_ndk

echo "Validating latest OS nightly..."

if [ $OLYMPIABUILDCHOICE = "fledge" ] ; then
    if [ -z "$SIMULATOR_OSNDKDIR" ] || [ ! -d "$SIMULATOR_OSNDKDIR" ] || [ ! -d "$SIMULATOR_OSNDKDIR/inc" ] ; then
        export SIMULATOR_OSNDKDIR=$OLYMPIAJAVA/lynx/fledge/os_ndk/
        if [ ! -d "$SIMULATOR_OSNDKDIR/inc" ] ; then
            echo "WARNING: Simulator OSNDK directory does not appear to be valid!"
        fi
    fi
    export OSNDKDIR=$SIMULATOR_OSNDKDIR
else
    source "$BBNSLDIR/tools/nightly/osndk_latest.env"
    
    # Now we cache the remainder of the OS in $CACHEOSDIR
    echo "Validating latest OS nightly..."
    
    if [ ! -f "$CACHEDIR/original_location.txt" ] ; then
        echo "Error:  OSNDK failed to cache!"
        $(exit 1);
    fi
    
    CURRENT_OSDIR=`cat "$CACHEDIR/original_location.txt" | sed -e 's/os_ndk\/*$//'`
    
    if [ -z "$CURRENT_OSDIR" ] ; then
        CURRENT_OSDIR=UNKNOWN
    fi
    
    if [ -z `grep "$CURRENT_OSDIR" "$CACHEOSDIR/original_location.txt"` ]; then
        echo "Creating OS cache in $CACHEOSDIR"
        
        RETURNCODE=0
        echo "Copying OS files from $CURRENT_OSDIR to $CACHEOSDIR"
        cp -a -f "$CURRENT_OSDIR"/{applink,include,tools} "$CACHEOSDIR"
        let RETURNCODE+=$?
        mkdir -p "$CACHEOSDIR/bin"
        cp -f "$CURRENT_OSDIR"/bin/$PLATFORMNAME*  "$CACHEOSDIR/bin"
        let RETURNCODE+=$?
        mkdir -p "$CACHEOSDIR/debug"

        # Not all OS published shares have this file (notably oxford ones)
        if [ -f "$CURRENT_OSDIR"/debug/$PLATFORMNAME.datz ] ; then
            cp -f "$CURRENT_OSDIR"/debug/$PLATFORMNAME.datz "$CACHEOSDIR/debug"
        fi

        let RETURNCODE+=$?
        
        if [ $RETURNCODE -eq 0 ] ; then
            echo "$CURRENT_OSDIR" > "$CACHEOSDIR/original_location.txt"
        else
            echo "Error:  Build Failure occurred in ob-bbnsl: copy failed!"
        fi
    else
        echo "OS cache is up to date"
    fi
    
    if [ ! -d "$OSNDKDIR/inc" ] ; then
        echo "WARNING: OSNDK directory does not appear to be valid!"
    fi
    
    # Set ARMOSDIR to a Windows path that Lynx will understand
    export ARMOSDIR=`echo $CACHEOSDIR | sed -e 's/\/\([a-zA-Z]\)\//\1:\\\/g' -e 's/\//\\\/g'` # Convert /c/ to c:\ and / to \
fi
